#!/usr/bin/env bash
set -euo pipefail

# Build menu: header actions + paired devices with connect/disconnect state
mapfile -t devices < <(bluetoothctl paired-devices | awk '{print $2}' 2>/dev/null || true)

entries=("Toggle Power" "Scan On" "Scan Off" "Open Blueman Manager")

# Add paired devices to menu
for mac in "${devices[@]}"; do
    if [[ -n "$mac" ]]; then
        name="$(bluetoothctl info "$mac" 2>/dev/null | awk -F': ' '/Name:/ {print $2}' | head -n1 || echo "Unknown Device")"
        connected="$(bluetoothctl info "$mac" 2>/dev/null | awk -F': ' '/Connected:/ {print $2}' || echo "no")"
        
        if [[ "$connected" == "yes" ]]; then
            entries+=("Disconnect :: $name :: $mac")
        else
            entries+=("Connect :: $name :: $mac")
        fi
    fi
done

# Show fuzzel menu with dark theme, golden text, and 80% transparency
choice="$(printf "%s\n" "${entries[@]}" | fuzzel --dmenu \
    --prompt='Bluetooth ' \
    --lines=12 \
    --width=40 \
    --background-color='000000cc' \
    --text-color='ffd700ff' \
    --selection-color='333333cc' \
    --selection-text-color='ffd700ff' \
    --border-color='ffd70080' \
    --border-width=2)"

# Handle selection
case "$choice" in
    "Toggle Power")
        if bluetoothctl show 2>/dev/null | grep -q "Powered: yes"; then
            bluetoothctl power off
        else
            bluetoothctl power on
        fi
        ;;
    "Scan On") 
        bluetoothctl scan on &
        ;;
    "Scan Off") 
        bluetoothctl scan off 
        ;;
    "Open Blueman Manager") 
        blueman-manager & 
        ;;
    Connect*" :: "*) 
        mac="$(echo "$choice" | awk -F' :: ' '{print $3}')"
        bluetoothctl connect "$mac"
        ;;
    Disconnect*" :: "*) 
        mac="$(echo "$choice" | awk -F' :: ' '{print $3}')"
        bluetoothctl disconnect "$mac"
        ;;
    *) 
        exit 0 
        ;;
esac